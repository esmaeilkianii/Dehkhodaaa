<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>داشبورد مزارع (مسیریابی سریع و سفارشی)</title>
</head>
<body>
<!-- partial:index.partial.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>داشبورد مدیریت مزارع نیشکر (سه‌بعدی)</title>
    <link href='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #4a90e2; --primary-dark: #357ABD; --text-dark: #2c3e50; --text-light: #7f8c8d; --bg-light: #f7f9fb; --white: #ffffff; --border-color: #e9ecef; --shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Vazirmatn', sans-serif; min-height: 100vh; color: var(--text-dark); background-color: var(--bg-light); overflow: hidden; }
        .dashboard-container { height: 100vh; width: 100%; position: relative; }

        /* --- Control Panel --- */
        .control-panel { background: var(--white); padding: 25px; box-shadow: var(--shadow); overflow-y: auto; position: fixed; top: 0; right: 0; height: 100vh; width: 400px; max-width: 90%; z-index: 2000; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .control-panel.open { transform: translateX(0); }
        
        /* --- Panel Toggle & Reset Buttons --- */
        .panel-toggle-btn { position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; background: var(--primary-color); color: var(--white); border-radius: 50%; border: none; box-shadow: 0 6px 15px rgba(74, 144, 226, 0.4); font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2001; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .control-panel.open ~ .map-container .panel-toggle-btn { transform: translateX(calc(-400px - 20px)); }
        
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .reset-btn { background: #f0f2f5; color: var(--text-light); border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 18px; cursor: pointer; transition: all 0.3s ease; }
        .reset-btn:hover { background: var(--primary-color); color: var(--white); transform: rotate(180deg); }

        /* --- Filters & Cards --- */
        .filter-section { margin-bottom: 25px; background: var(--bg-light); padding: 20px; border-radius: 12px; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-btn { padding: 10px 18px; border: 1px solid var(--border-color); background: var(--white); border-radius: 25px; cursor: pointer; transition: all 0.2s ease; font-size: 13px; font-weight: 500; }
        .filter-btn.active { background: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        .location-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, var(--primary-color), var(--primary-dark)); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
        .stat-number { font-size: 26px; font-weight: 700; color: var(--primary-color); }
        .stat-label { font-size: 12px; color: var(--text-light); }

        /* --- Map Container & Overlays --- */
        .map-container { width: 100%; height: 100%; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .search-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 400px; max-width: 90%; }
        .search-input { width: 100%; padding: 15px 50px 15px 25px; border: none; border-radius: 30px; font-size: 14px; outline: none; box-shadow: var(--shadow); }
        .search-icon { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .location-fab { position: absolute; bottom: 30px; left: 30px; width: 55px; height: 55px; background-color: var(--primary-color); color: white; border-radius: 50%; border: none; box-shadow: 0 6px 15px rgba(74, 144, 226, 0.4); font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }
        .user-location-marker { background-color: #3498db; border: 3px solid white; border-radius: 50%; width: 25px; height: 25px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(52, 152, 219, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); } }
        
        .route-summary-card { position: absolute; top: 90px; left: 50%; transform: translateX(-50%); background: var(--white); padding: 20px; border-radius: 15px; box-shadow: var(--shadow); z-index: 1000; width: 300px; }
        .summary-item { display: flex; align-items: center; gap: 12px; font-size: 14px; margin-bottom: 10px; }
        .summary-item i { width: 22px; text-align: center; color: var(--primary-color); }
        #close-summary-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; font-size: 24px; cursor: pointer; }
        
        .map-overlay { position: absolute; bottom: 30px; right: 30px; background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 12px; z-index: 1000; }
        .custom-marker { border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; cursor: pointer; background-color: #fff; font-size: 14px; }
        .group-1 .fa-leaf { color: #e74c3c; } .group-2 .fa-leaf { color: #3498db; } .group-3 .fa-leaf { color: #f1c40f; } .group-4 .fa-leaf { color: #9b59b6; }
        .maplibregl-popup-content { border-radius: 12px !important; box-shadow: var(--shadow); padding: 0 !important; }
        .popup-content { text-align: right; padding: 15px; min-width: 180px; }
        .popup-info { display: flex; flex-direction: column; gap: 10px; }
        .popup-info > div { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .popup-info i { width: 20px; text-align: center; color: var(--primary-color); }
        .route-btn { margin-top: 15px; padding: 10px 18px; width: 100%; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; }

        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); z-index: 10000; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 15px; }
        .loading.show { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="spinner"></div><div>در حال پردازش...</div></div>
    <div class="dashboard-container">
        <!-- Panel content -->
        <div class="control-panel" id="controlPanel">
            <div class="panel-header">
                <div class="panel-header-title"><h1><i class="fas fa-seedling"></i> داشبورد مزارع</h1><p>فیلتر و مدیریت داده‌ها</p></div>
                <button class="reset-btn" id="resetBtn" title="ریست کردن برنامه"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="filter-section">
                <h3><i class="fas fa-calendar-week"></i> فیلتر روز هفته</h3>
                <div class="filter-buttons" id="dayFilters">
                    <button class="filter-btn active" data-day="all">همه</button>
                    <button class="filter-btn" data-day="شنبه">شنبه</button>
                    <button class="filter-btn" data-day="یکشنبه">یکشنبه</button>
                    <button class="filter-btn" data-day="دوشنبه">دوشنبه</button>
                    <button class="filter-btn" data-day="سه شنبه">سه شنبه</button>
                    <button class="filter-btn" data-day="چهارشنبه">چهارشنبه</button>
                    <button class="filter-btn" data-day="پنجشنبه">پنجشنبه</button>
                </div>
            </div>
            <div class="filter-section">
                <h3><i class="fas fa-layer-group"></i> فیلتر گروه</h3>
                <div class="filter-buttons" id="groupFilters">
                    <button class="filter-btn active" data-group="all">همه</button>
                    <button class="filter-btn" data-group="1">گروه ۱</button>
                    <button class="filter-btn" data-group="2">گروه ۲</button>
                    <button class="filter-btn" data-group="3">گروه ۳</button>
                    <button class="filter-btn" data-group="4">گروه ۴</button>
                </div>
            </div>
             <div class="filter-section">
                <h3><i class="fas fa-route"></i> کنترل مسیریابی</h3>
                <button class="location-btn" id="setOriginBtn"><i class="fas fa-map-pin"></i> انتخاب مبدا روی نقشه</button>
            </div>
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="stat-card"><div class="stat-number" id="totalFarms">0</div><div class="stat-label">کل مزارع</div></div>
                <div class="stat-card"><div class="stat-number" id="visibleFarms">0</div><div class="stat-label">مزارع نمایان</div></div>
            </div>
        </div>

        <!-- Map and overlays -->
        <div class="map-container">
            <button class="panel-toggle-btn" id="panelToggleBtn" title="نمایش پنل"><i class="fas fa-sliders-h"></i></button>
            <div class="search-overlay">
                <div class="search-container">
                    <input type="text" class="search-input" id="farmSearch" placeholder="جستجوی نام مزرعه..."><i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div id="route-summary" class="route-summary-card" style="display: none;">
                <button id="close-summary-btn" title="بستن">×</button>
                <div class="summary-item"><i class="fas fa-road"></i><span id="route-distance"></span></div>
                <div class="summary-item"><i class="fas fa-stopwatch"></i><span id="route-time"></span></div>
            </div>
            <div id="map"></div>
            <button class="location-fab" id="findMeBtn" title="موقعیت من"><i class="fas fa-location-crosshairs"></i></button>
        </div>
    </div>
    
    <script src='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js'></script>
    <script>
        // --- CONFIGURATION ---
        const AVERAGE_SPEED_KPH = 80; // <-- *** ADJUST THIS VALUE FOR YOUR COMPANY'S AVERAGE SPEED ***

        const farmsData = {
            "01-22": {"روز": "شنبه", "گروه": 1, "longitude": 48.775708, "latitude": 31.593218},
            "01-28": {"روز": "شنبه", "گروه": 1, "longitude": 48.785815, "latitude": 31.592482},
            "02-03": {"روز": "شنبه", "گروه": 2, "longitude": 48.742486, "latitude": 31.596457},
            "02-13": {"روز": "شنبه", "گروه": 2, "longitude": 48.729089, "latitude": 31.597671},
            "02-19": {"روز": "شنبه", "گروه": 2, "longitude": 48.723132, "latitude": 31.5984},
            "02-27": {"روز": "شنبه", "گروه": 2, "longitude": 48.712418, "latitude": 31.599372},
            "03-08": {"روز": "شنبه", "گروه": 1, "longitude": 48.757886, "latitude": 31.58573},
            "03-16": {"روز": "شنبه", "گروه": 1, "longitude": 48.766544, "latitude": 31.584765},
            "03-18": {"روز": "شنبه", "گروه": 1, "longitude": 48.769229, "latitude": 31.584519},
            "03-22": {"روز": "شنبه", "گروه": 1, "longitude": 48.774562, "latitude": 31.584025},
            "03-30": {"روز": "یکشنبه", "گروه": 1, "longitude": 48.78511, "latitude": 31.583048},
            "03-32": {"روز": "یکشنبه", "گروه": 1, "longitude": 48.78769, "latitude": 31.582802},
            "04-01": {"روز": "یکشنبه", "گروه": 2, "longitude": 48.744039, "latitude": 31.586804},
            "04-03": {"روز": "یکشنبه", "گروه": 2, "longitude": 48.741306, "latitude": 31.587052},
            "04-05": {"روز": "یکشنبه", "گروه": 2, "longitude": 48.738659, "latitude": 31.587293},
            "04-11": {"روز": "شنبه", "گروه": 2, "longitude": 48.732634, "latitude": 31.588026},
            "04-15": {"روز": "شنبه", "گروه": 2, "longitude": 48.727248, "latitude": 31.588536},
            "05-01": {"روز": "یکشنبه", "گروه": 1, "longitude": 48.746612, "latitude": 31.57751},
            "05-06": {"روز": "دوشنبه", "گروه": 1, "longitude": 48.750875, "latitude": 31.567808},
            "05-07": {"روز": "یکشنبه", "گروه": 1, "longitude": 48.75473, "latitude": 31.576771},
            "05-10": {"روز": "دوشنبه", "گروه": 1, "longitude": 48.756231, "latitude": 31.56732},
            "05-11": {"روز": "یکشنبه", "گروه": 1, "longitude": 48.760087, "latitude": 31.576284},
            "05-15": {"روز": "یکشنبه", "گروه": 1, "longitude": 48.765431, "latitude": 31.575806},
            "05-16": {"روز": "دوشنبه", "گروه": 1, "longitude": 48.76419, "latitude": 31.566614},
            "05-18": {"روز": "دوشنبه", "گروه": 1, "longitude": 48.76699, "latitude": 31.566357},
            "05-19": {"روز": "یکشنبه", "گروه": 1, "longitude": 48.772838, "latitude": 31.575307},
            "05-20": {"روز": "دوشنبه", "گروه": 1, "longitude": 48.769651, "latitude": 31.566097},
            "05-22": {"روز": "دوشنبه", "گروه": 1, "longitude": 48.774337, "latitude": 31.565856},
            "05-30": {"روز": "دوشنبه", "گروه": 1, "longitude": 48.785005, "latitude": 31.564851},
            "06-02": {"روز": "یکشنبه", "گروه": 2, "longitude": 48.742926, "latitude": 31.577845},
            "06-03": {"روز": "دوشنبه", "گروه": 2, "longitude": 48.739048, "latitude": 31.568883},
            "06-04": {"روز": "یکشنبه", "گروه": 2, "longitude": 48.740192, "latitude": 31.578093},
            "06-05": {"روز": "دوشنبه", "گروه": 2, "longitude": 48.736401, "latitude": 31.569123},
            "06-10": {"روز": "یکشنبه", "گروه": 2, "longitude": 48.73423, "latitude": 31.57882},
            "06-11": {"روز": "دوشنبه", "گروه": 2, "longitude": 48.728336, "latitude": 31.569856},
            "06-12": {"روز": "یکشنبه", "گروه": 2, "longitude": 48.729479, "latitude": 31.579067},
            "06-16": {"روز": "دوشنبه", "گروه": 2, "longitude": 48.724209, "latitude": 31.57953},
            "06-18": {"روز": "دوشنبه", "گروه": 2, "longitude": 48.721473, "latitude": 31.579815},
            "07-08": {"روز": "سه شنبه", "گروه": 1, "longitude": 48.752442, "latitude": 31.558382},
            "07-10": {"روز": "سه شنبه", "گروه": 1, "longitude": 48.75483, "latitude": 31.558141},
            "07-12": {"روز": "سه شنبه", "گروه": 1, "longitude": 48.757797, "latitude": 31.557894},
            "07-18": {"روز": "سه شنبه", "گروه": 1, "longitude": 48.767829, "latitude": 31.557159},
            "08-01": {"روز": "دوشنبه", "گروه": 2, "longitude": 48.740637, "latitude": 31.559433},
            "08-09": {"روز": "دوشنبه", "گروه": 2, "longitude": 48.729903, "latitude": 31.560409},
            "08-17": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.71921, "latitude": 31.561368},
            "08-19": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.71642, "latitude": 31.561628},
            "08-25": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.710524, "latitude": 31.562353},
            "09-04": {"روز": "چهارشنبه", "گروه": 1, "longitude": 48.745934, "latitude": 31.549596},
            "09-08": {"روز": "چهارشنبه", "گروه": 1, "longitude": 48.751289, "latitude": 31.549109},
            "09-14": {"روز": "سه شنبه", "گروه": 1, "longitude": 48.759289, "latitude": 31.54838},
            "09-16": {"روز": "سه شنبه", "گروه": 1, "longitude": 48.762068, "latitude": 31.54815},
            "09-20": {"روز": "سه شنبه", "گروه": 1, "longitude": 48.7694, "latitude": 31.547645},
            "10-01": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.739487, "latitude": 31.550182},
            "10-11": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.726045, "latitude": 31.551404},
            "10-13": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.723399, "latitude": 31.551644},
            "10-15": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.72078, "latitude": 31.551891},
            "10-23": {"روز": "سه شنبه", "گروه": 2, "longitude": 48.70998, "latitude": 31.552862},
            "11-06": {"روز": "پنجشنبه", "گروه": 1, "longitude": 48.747445, "latitude": 31.540226},
            "11-12": {"روز": "پنجشنبه", "گروه": 1, "longitude": 48.757481, "latitude": 31.539474},
            "11-16": {"روز": "چهارشنبه", "گروه": 1, "longitude": 48.760917, "latitude": 31.539002},
            "11-18": {"روز": "چهارشنبه", "گروه": 1, "longitude": 48.763639, "latitude": 31.538713},
            "11-20": {"روز": "چهارشنبه", "گروه": 1, "longitude": 48.766215, "latitude": 31.538516},
            "11-22": {"روز": "چهارشنبه", "گروه": 1, "longitude": 48.768861, "latitude": 31.538274},
            "11-26": {"روز": "چهارشنبه", "گروه": 1, "longitude": 48.774215, "latitude": 31.537786},
            "12-04": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.735634, "latitude": 31.541404},
            "12-06": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.732988, "latitude": 31.541645},
            "12-12": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.724925, "latitude": 31.542377},
            "12-13": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.721146, "latitude": 31.533382},
            "12-15": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.718469, "latitude": 31.533411},
            "12-21": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.710425, "latitude": 31.534343},
            "12-24": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.710907, "latitude": 31.543836},
            "12-27": {"روز": "چهارشنبه", "گروه": 2, "longitude": 48.704405, "latitude": 31.535621},
            "13-04": {"روز": "پنجشنبه", "گروه": 1, "longitude": 48.743665, "latitude": 31.531346},
            "13-10": {"روز": "پنجشنبه", "گروه": 1, "longitude": 48.751664, "latitude": 31.530617},
            "13-22": {"روز": "پنجشنبه", "گروه": 1, "longitude": 48.767725, "latitude": 31.529154, "polygon": [[ [48.766, 31.530], [48.769, 31.530], [48.769, 31.528], [48.766, 31.528], [48.766, 31.530] ]]},
            "14-02": {"روز": "شنبه", "گروه": 4, "longitude": 48.7361, "latitude": 31.522914, "polygon": [[ [48.735, 31.524], [48.737, 31.524], [48.737, 31.522], [48.735, 31.522], [48.735, 31.524] ]]},
            "14-07": {"روز": "شنبه", "گروه": 4, "longitude": 48.726867, "latitude": 31.514403},
            "14-09": {"روز": "شنبه", "گروه": 4, "longitude": 48.724222, "latitude": 31.514643},
            "14-16": {"روز": "شنبه", "گروه": 4, "longitude": 48.71725, "latitude": 31.524618},
            "14-18": {"روز": "شنبه", "گروه": 4, "longitude": 48.71428, "latitude": 31.524866},
            "14-19": {"روز": "شنبه", "گروه": 4, "longitude": 48.712853, "latitude": 31.515862},
            "14-21": {"روز": "شنبه", "گروه": 4, "longitude": 48.710208, "latitude": 31.516102},
            "14-24": {"روز": "شنبه", "گروه": 4, "longitude": 48.708646, "latitude": 31.525594},
            "15-03": {"روز": "شنبه", "گروه": 3, "longitude": 48.742545, "latitude": 31.522328},
            "15-04": {"روز": "شنبه", "گروه": 3, "longitude": 48.74142, "latitude": 31.513082},
            "15-07": {"روز": "شنبه", "گروه": 3, "longitude": 48.747898, "latitude": 31.521841},
            "15-08": {"روز": "یکشنبه", "گروه": 3, "longitude": 48.746748, "latitude": 31.512595},
            "15-10": {"روز": "یکشنبه", "گروه": 3, "longitude": 48.749393, "latitude": 31.512354},
            "15-11": {"روز": "شنبه", "گروه": 3, "longitude": 48.753251, "latitude": 31.521353},
            "15-12": {"روز": "یکشنبه", "گروه": 3, "longitude": 48.75112, "latitude": 31.512081},
            "15-17": {"روز": "شنبه", "گروه": 3, "longitude": 48.761367, "latitude": 31.520622},
            "15-22": {"روز": "یکشنبه", "گروه": 3, "longitude": 48.76523, "latitude": 31.51089},
            "15-24": {"روز": "یکشنبه", "گروه": 3, "longitude": 48.768158, "latitude": 31.510643},
            "15-25": {"روز": "شنبه", "گروه": 3, "longitude": 48.771955, "latitude": 31.519648},
            "15-27": {"روز": "شنبه", "گروه": 3, "longitude": 48.774229, "latitude": 31.519426},
            "16-01": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.73238, "latitude": 31.495441},
            "16-03": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.729957, "latitude": 31.495689},
            "16-04": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.731104, "latitude": 31.504929},
            "16-07": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.724606, "latitude": 31.496176},
            "16-09": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.721961, "latitude": 31.496416},
            "16-12": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.720399, "latitude": 31.505896},
            "16-13": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.718651, "latitude": 31.496902},
            "16-22": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.70705, "latitude": 31.507108},
            "16-24": {"روز": "یکشنبه", "گروه": 4, "longitude": 48.704342, "latitude": 31.507354},
            "16-27": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.699892, "latitude": 31.498579},
            "17-02": {"روز": "دوشنبه", "گروه": 3, "longitude": 48.738465, "latitude": 31.495104},
            "17-08": {"روز": "دوشنبه", "گروه": 3, "longitude": 48.744482, "latitude": 31.494367},
            "17-09": {"روز": "یکشنبه", "گروه": 3, "longitude": 48.74815, "latitude": 31.50336},
            "17-11": {"روز": "یکشنبه", "گروه": 3, "longitude": 48.750982, "latitude": 31.503113},
            "17-19": {"روز": "دوشنبه", "گروه": 3, "longitude": 48.761686, "latitude": 31.502138},
            "17-24": {"روز": "دوشنبه", "گروه": 3, "longitude": 48.765867, "latitude": 31.492434},
            "17-26": {"روز": "دوشنبه", "گروه": 3, "longitude": 48.768533, "latitude": 31.492175},
            "17-27": {"روز": "دوشنبه", "گروه": 3, "longitude": 48.772324, "latitude": 31.500955},
            "18-02": {"روز": "سه شنبه", "گروه": 4, "longitude": 48.731552, "latitude": 31.486458},
            "18-03": {"روز": "سه شنبه", "گروه": 4, "longitude": 48.727697, "latitude": 31.477473},
            "18-06": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.726198, "latitude": 31.486947},
            "18-10": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.720847, "latitude": 31.487434},
            "18-13": {"روز": "سه شنبه", "گروه": 4, "longitude": 48.714351, "latitude": 31.478686},
            "18-16": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.712832, "latitude": 31.488162},
            "18-17": {"روز": "سه شنبه", "گروه": 4, "longitude": 48.708957, "latitude": 31.479176},
            "18-18": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.710101, "latitude": 31.48841},
            "18-24": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.704129, "latitude": 31.489137},
            "18-26": {"روز": "دوشنبه", "گروه": 4, "longitude": 48.701485, "latitude": 31.489377},
            "19-05": {"روز": "دوشنبه", "گروه": 3, "longitude": 48.740659, "latitude": 31.485631},
            "19-04": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.736868, "latitude": 31.476638},
            "19-08": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.742219, "latitude": 31.476151},
            "19-13": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.75113, "latitude": 31.484656},
            "19-15": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.754124, "latitude": 31.484399},
            "19-18": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.755699, "latitude": 31.47488},
            "19-19": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.759419, "latitude": 31.483922},
            "19-21": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.762063, "latitude": 31.483681},
            "19-22": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.762865, "latitude": 31.476455},
            "19-23": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.76477, "latitude": 31.483434},
            "19-25": {"روز": "سه شنبه", "گروه": 3, "longitude": 48.767414, "latitude": 31.483192},
            "20-05": {"روز": "چهارشنبه", "گروه": 4, "longitude": 48.724836, "latitude": 31.459515},
            "20-06": {"روز": "چهارشنبه", "گروه": 4, "longitude": 48.723938, "latitude": 31.468731},
            "20-08": {"روز": "چهارشنبه", "گروه": 4, "longitude": 48.721232, "latitude": 31.468977},
            "20-09": {"روز": "چهارشنبه", "گروه": 4, "longitude": 48.717507, "latitude": 31.460276},
            "20-12": {"روز": "چهارشنبه", "گروه": 4, "longitude": 48.715882, "latitude": 31.469463},
            "20-13": {"روز": "چهارشنبه", "گروه": 4, "longitude": 48.714088, "latitude": 31.461797},
            "20-14": {"روز": "چهارشنبه", "گروه": 4, "longitude": 48.713238, "latitude": 31.469703},
            "20-24": {"روز": "سه شنبه", "گروه": 4, "longitude": 48.699831, "latitude": 31.470921},
            "20-26": {"روز": "سه شنبه", "گروه": 4, "longitude": 48.697329, "latitude": 31.471161},
            "20-28": {"روز": "سه شنبه", "گروه": 4, "longitude": 48.694473, "latitude": 31.471369},
            "21-03": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.735753, "latitude": 31.467655},
            "21-09": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.743747, "latitude": 31.466928},
            "21-15": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.751786, "latitude": 31.466212},
            "22-05": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.720865, "latitude": 31.449558},
            "22-17": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.709737, "latitude": 31.45786},
            "22-21": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.69896, "latitude": 31.46234},
            "23-07": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.740853, "latitude": 31.449091},
            "23-11": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.744078, "latitude": 31.448378},
            "23-13": {"روز": "چهارشنبه", "گروه": 3, "longitude": 48.74688, "latitude": 31.450136},
            "24-03": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.713667, "latitude": 31.43707},
            "24-04": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.714569, "latitude": 31.445983},
            "24-08": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.707391, "latitude": 31.447093},
            "24-11": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.700694, "latitude": 31.438168},
            "24-15": {"روز": "پنجشنبه", "گروه": 4, "longitude": 48.695322, "latitude": 31.438717},
            "25-03": {"روز": "پنجشنبه", "گروه": 3, "longitude": 48.725837, "latitude": 31.444494},
            "25-07": {"روز": "پنجشنبه", "گروه": 3, "longitude": 48.73025, "latitude": 31.442161},
            "25-09": {"روز": "پنجشنبه", "گروه": 3, "longitude": 48.732391, "latitude": 31.44061},
            "25-13": {"روز": "پنجشنبه", "گروه": 3, "longitude": 48.73790, "latitude": 31.43534},
            "26-02": {"روز": "پنجشنبه", "گروه": 2, "longitude": 48.712792, "latitude": 31.427019},
            "26-08": {"روز": "پنجشنبه", "گروه": 2, "longitude": 48.706911, "latitude": 31.427816},
            "26-09": {"روز": "پنجشنبه", "گروه": 2, "longitude": 48.700919, "latitude": 31.419888},
            "26-14": {"روز": "پنجشنبه", "گروه": 2, "longitude": 48.696682, "latitude": 31.428623},
            "26-15": {"روز": "پنجشنبه", "گروه": 2, "longitude": 48.694788, "latitude": 31.420752},
            "26-18": {"روز": "پنجشنبه", "گروه": 2, "longitude": 48.691303, "latitude": 31.429179},
            "27-01": {"روز": "پنجشنبه", "گروه": 3, "longitude": 48.717987, "latitude": 31.437501},
            "29-02": {"روز": "پنجشنبه", "گروه": 3, "longitude": 48.716572, "latitude": 31.418526}
        };

        const DOMElements = { controlPanel: document.getElementById('controlPanel'), panelToggleBtn: document.getElementById('panelToggleBtn'), loadingIndicator: document.getElementById('loading'), farmSearchInput: document.getElementById('farmSearch'), dayFilterContainer: document.getElementById('dayFilters'), groupFilterContainer: document.getElementById('groupFilters'), setOriginBtn: document.getElementById('setOriginBtn'), findMeBtn: document.getElementById('findMeBtn'), closeSummaryBtn: document.getElementById('close-summary-btn'), routeSummaryCard: document.getElementById('route-summary'), routeDistanceEl: document.getElementById('route-distance'), routeTimeEl: document.getElementById('route-time'), totalFarmsEl: document.getElementById('totalFarms'), visibleFarmsEl: document.getElementById('visibleFarms'), resetBtn: document.getElementById('resetBtn'), };
        const initialViewState = { center: [48.74, 31.52], zoom: 11.5, pitch: 45, bearing: 0 };
        let map, markers = [], originMarker = null;
        let currentFilters = { day: 'all', group: 'all' };

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEventListeners();
            displayFarms();
        });

        function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://api.maptiler.com/maps/satellite/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL',
                center: initialViewState.center, zoom: initialViewState.zoom, pitch: initialViewState.pitch, bearing: initialViewState.bearing,
                rtlTextPlugin: 'https://unpkg.com/maplibre-gl-rtl-text@0.2.3/dist/maplibre-gl-rtl-text.min.js'
            });
            map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'bottom-right');
        }
        
        function displayFarms() {
            markers.forEach(marker => marker.remove());
            markers = [];
            const visibleFarms = Object.entries(farmsData).filter(([, f]) => (currentFilters.day === 'all' || f.روز === currentFilters.day) && (currentFilters.group === 'all' || f.گروه.toString() === currentFilters.group));
            
            visibleFarms.forEach(([farmId, farm]) => {
                const el = document.createElement('div');
                el.className = `custom-marker group-${farm.گروه}`;
                el.innerHTML = `<i class="fas fa-leaf"></i>`;
                const popup = new maplibregl.Popup({ offset: 35, closeButton: false }).setHTML(createPopupHTML(farmId, farm));
                popup.on('open', () => showFarmArea(farm)).on('close', hideFarmArea);
                const marker = new maplibregl.Marker(el).setLngLat([farm.longitude, farm.latitude]).setPopup(popup).addTo(map);
                marker.getElement().dataset.farmId = farmId;
                markers.push(marker);
            });
            updateStats(visibleFarms);
        }
        
        function createPopupHTML(farmId, farm) {
            const areaHTML = farm.polygon ? `<div><i class="fas fa-ruler-combined"></i>مساحت: <strong>${calculatePolygonArea(farm.polygon[0]).toFixed(2)} هکتار</strong></div>` : '';
            return `<div class="popup-content"><h4>مزرعه <span style="direction: ltr; unicode-bidi: isolate; display: inline-block;">${farmId}</span></h4><div class="popup-info"><div><i class="fas fa-calendar-day"></i>روز: <strong>${farm.روز}</strong></div><div><i class="fas fa-layer-group"></i>گروه: <strong>${farm.گروه}</strong></div>${areaHTML}</div><button class="route-btn" onclick="handleRouteButtonClick(${farm.longitude}, ${farm.latitude})"><i class="fas fa-route"></i> مسیریابی</button></div>`;
        }

        function showFarmArea(farm) {
            if (!farm.polygon) return;
            hideFarmArea();
            map.addSource('farm-area', { 'type': 'geojson', 'data': { 'type': 'Polygon', 'coordinates': farm.polygon } });
            map.addLayer({ 'id': 'farm-area-fill', 'type': 'fill', 'source': 'farm-area', 'paint': { 'fill-color': 'var(--primary-color)', 'fill-opacity': 0.3 } });
            map.addLayer({ 'id': 'farm-area-outline', 'type': 'line', 'source': 'farm-area', 'paint': { 'line-color': 'var(--primary-color)', 'line-width': 2 } });
        }
        function hideFarmArea() {
            if (map.getLayer('farm-area-fill')) map.removeLayer('farm-area-fill');
            if (map.getLayer('farm-area-outline')) map.removeLayer('farm-area-outline');
            if (map.getSource('farm-area')) map.removeSource('farm-area');
        }
        function calculatePolygonArea(coords) {
            let area = 0;
            for (let i = 0; i < coords.length - 1; i++) { area += (coords[i][0] * coords[i+1][1] - coords[i+1][0] * coords[i][1]); }
            const squareMeters = Math.abs(area / 2) * Math.pow(111320 * Math.cos(coords[0][1] * Math.PI / 180), 2);
            return squareMeters / 10000;
        }

        async function showRoute(start, end) {
            showLoading(true);
            hideRoute();
            const url = `https://router.project-osrm.org/route/v1/driving/${start[0]},${start[1]};${end[0]},${end[1]}?overview=full&geometries=geojson`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code !== 'Ok') throw new Error(data.message || 'Routing failed');
                
                const routeGeometry = data.routes[0].geometry;
                const distanceMeters = data.routes[0].distance;
                
                // *** NEW: Custom Time Calculation ***
                const travelTimeSeconds = (distanceMeters / 1000) / AVERAGE_SPEED_KPH * 3600;

                map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': routeGeometry } });
                map.addLayer({ 'id': 'route', 'type': 'line', 'source': 'route', 'paint': { 'line-color': 'var(--primary-color)', 'line-width': 7, 'line-opacity': 0.8 } });
                
                const bounds = routeGeometry.coordinates.reduce((b, c) => b.extend(c), new maplibregl.LngLatBounds(start, end));
                map.fitBounds(bounds, { padding: { top: 150, bottom: 50, left: 50, right: 50 } });

                DOMElements.routeDistanceEl.textContent = formatDistance(distanceMeters);
                DOMElements.routeTimeEl.textContent = `~ ${formatDuration(travelTimeSeconds)}`;
                DOMElements.routeSummaryCard.style.display = 'block';

            } catch (error) { console.error("Routing Error:", error); alert('خطا در مسیریابی.'); } 
            finally { showLoading(false); }
        }

        function formatDistance(meters) {
            if (meters < 1000) return `${Math.round(meters)} متر`;
            return `${(meters / 1000).toFixed(1)} کیلومتر`;
        }
        function formatDuration(seconds) {
            if (seconds < 60) return "کمتر از یک دقیقه";
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.round((seconds % 3600) / 60);
            if (hours > 0) return `${hours} ساعت و ${minutes} دقیقه`;
            return `${minutes} دقیقه`;
        }
        function hideRoute() {
            if (map.getLayer('route')) map.removeLayer('route');
            if (map.getSource('route')) map.removeSource('route');
            DOMElements.routeSummaryCard.style.display = 'none';
        }

        window.handleRouteButtonClick = (lng, lat) => {
            if (!originMarker) { alert('لطفا ابتدا مبدا را مشخص کنید.'); return; }
            showRoute(originMarker.getLngLat().toArray(), [lng, lat]);
        };
        
        function setupEventListeners() {
            DOMElements.panelToggleBtn.addEventListener('click', togglePanel);
            DOMElements.resetBtn.addEventListener('click', resetApplication);
            DOMElements.dayFilterContainer.addEventListener('click', (e) => handleFilterClick(e, 'day', DOMElements.dayFilterContainer));
            DOMElements.groupFilterContainer.addEventListener('click', (e) => handleFilterClick(e, 'group', DOMElements.groupFilterContainer));
            DOMElements.farmSearchInput.addEventListener('keydown', handleSearch);
            DOMElements.setOriginBtn.addEventListener('click', enableOriginSelection);
            DOMElements.findMeBtn.addEventListener('click', findMeAndSetOrigin);
            DOMElements.closeSummaryBtn.addEventListener('click', hideRoute);
        }
        function togglePanel() { DOMElements.controlPanel.classList.toggle('open'); DOMElements.panelToggleBtn.querySelector('i').className = DOMElements.controlPanel.classList.contains('open') ? 'fas fa-times' : 'fas fa-sliders-h'; }
        function handleFilterClick(e, type, container) { if (!e.target.classList.contains('filter-btn')) return; container.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); currentFilters[type] = e.target.dataset[type]; hideFarmArea(); displayFarms(); if (window.innerWidth <= 768) setTimeout(togglePanel, 300); }
        function resetApplication() { hideRoute(); hideFarmArea(); if (originMarker) originMarker.remove(); originMarker = null; currentFilters = { day: 'all', group: 'all' }; DOMElements.dayFilterContainer.querySelector('.active').classList.remove('active'); DOMElements.dayFilterContainer.querySelector('[data-day="all"]').classList.add('active'); DOMElements.groupFilterContainer.querySelector('.active').classList.remove('active'); DOMElements.groupFilterContainer.querySelector('[data-group="all"]').classList.add('active'); displayFarms(); DOMElements.farmSearchInput.value = ''; map.flyTo(initialViewState); if (DOMElements.controlPanel.classList.contains('open')) togglePanel(); }
        function setOrigin(lngLat, isUserLocation = false) { if (originMarker) originMarker.remove(); const el = document.createElement('div'); el.className = isUserLocation ? 'user-location-marker' : ''; if (!isUserLocation) el.style.cssText = 'background: #f39c12; border-radius: 50%; width: 20px; height: 20px; border: 3px solid white;'; originMarker = new maplibregl.Marker({ element: el, draggable: true }).setLngLat(lngLat).addTo(map); originMarker.on('dragend', () => { if (map.getSource('route')) { const dest = map.getSource('route')._data.geometry.coordinates.slice(-1)[0]; showRoute(originMarker.getLngLat().toArray(), dest); } }); }
        function findMeAndSetOrigin() { showLoading(true); navigator.geolocation.getCurrentPosition(pos => { const lngLat = [pos.coords.longitude, pos.coords.latitude]; setOrigin(lngLat, true); map.flyTo({ center: lngLat, zoom: 14 }); showLoading(false); }, () => { showLoading(false); alert('خطا در دریافت موقعیت.'); }, { enableHighAccuracy: true }); }
        function enableOriginSelection() { const btn = DOMElements.setOriginBtn; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> روی نقشه کلیک کنید...'; btn.disabled = true; map.getCanvas().style.cursor = 'crosshair'; map.once('click', (e) => { setOrigin(e.lngLat); map.getCanvas().style.cursor = ''; btn.innerHTML = '<i class="fas fa-check"></i> مبدا انتخاب شد'; setTimeout(() => { btn.innerHTML = '<i class="fas fa-map-pin"></i> انتخاب مبدا روی نقشه'; btn.disabled = false; }, 2500); }); }
        function handleSearch(e) { if (e.key !== 'Enter') return; const term = e.target.value.trim(); if (!term || !farmsData[term]) return alert(`مزرعه '${term}' یافت نشد.`); const farm = farmsData[term]; map.flyTo({ center: [farm.longitude, farm.latitude], zoom: 16 }); const marker = markers.find(m => m.getElement().dataset.farmId === term); if (marker) { setTimeout(() => { if (!marker.getPopup().isOpen()) marker.togglePopup(); handleRouteButtonClick(farm.longitude, farm.latitude); }, 500); } DOMElements.farmSearchInput.blur(); }
        function showLoading(show) { DOMElements.loadingIndicator.classList.toggle('show', show); }
        function updateStats(visibleFarms) { DOMElements.totalFarmsEl.textContent = Object.keys(farmsData).length; DOMElements.visibleFarmsEl.textContent = visibleFarms.length; }
    </script>
</body>
</html>
